<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seed Meals (One-time)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body style="font-family:Arial; max-width:760px; margin:20px auto;">

<h2>Seed Meals (one-time)</h2>
<p>
Loads <b>meals_250_MealsDB.json</b> and sends it to:
<b>POST /api/meal/bulkload</b><br>
<b>No login required.</b>
</p>

<button id="seedBtn">Start Seed</button>
<span id="msg" style="margin-left:10px;"></span>

<div style="margin-top:10px; background:#eee; height:12px; border-radius:999px; overflow:hidden;">
  <div id="bar" style="height:12px; width:0%; background:#0b5ed7;"></div>
</div>
<div id="progressText" style="margin-top:8px; color:#666;"></div>

<script>
  // ✅ Client in tar3, Server in tar1
  const API_BASE = "../tar1/api";
  const API_MEALS = API_BASE + "/meal";

  const JSON_FILE = "meals_250_MealsDB.json";
  const BATCH_SIZE = 25;

  function setProgress(done, total) {
    const pct = total === 0 ? 0 : Math.round((done / total) * 100);
    document.getElementById("bar").style.width = pct + "%";
    document.getElementById("progressText").innerText = `Progress: ${done}/${total} (${pct}%)`;
  }

  function mapToMeal(item) {
    return {
      Name: item.strMeal || "",
      Category: item.strCategory || "",
      Area: item.strArea || "",
      Instructions: item.strInstructions || "",
      Image: item.strMealThumb || "",
      Video: item.strYoutube || "",
      Source: item.strSource || "",
      Ingredients: Array.isArray(item.ingredients) ? item.ingredients.filter(x => x && x.trim()) : []
    };
  }

  function postBatch(batch) {
    return $.ajax({
      url: API_MEALS + "/bulkload",
      method: "POST",
      data: JSON.stringify(batch),
      contentType: "application/json"
    });
  }

  $("#seedBtn").on("click", function () {
    $("#seedBtn").prop("disabled", true);
    $("#msg").css("color","#666").text("Loading JSON...");
    setProgress(0, 1);

    $.getJSON(JSON_FILE)
      .done(function (data) {
        const raw = data && data.meals ? data.meals : [];
        const meals = raw.map(mapToMeal).filter(m => m.Name.trim().length > 0);

        const total = meals.length;
        if (total === 0) {
          $("#msg").css("color","red").text("JSON loaded but meals list is empty.");
          $("#seedBtn").prop("disabled", false);
          return;
        }

        let sent = 0;
        let insertedTotal = 0;

        $("#msg").css("color","#666").text(`Seeding ${total} meals...`);
        setProgress(0, total);

        function next() {
          if (sent >= total) {
            $("#msg").css("color","green").text(`Done! Inserted about ${insertedTotal} meals.`);
            $("#seedBtn").prop("disabled", false);
            setProgress(total, total);
            return;
          }

          const batch = meals.slice(sent, sent + BATCH_SIZE);

          postBatch(batch)
            .done(function (res) {
              if (res && typeof res.inserted === "number") insertedTotal += res.inserted;
              sent += batch.length;
              setProgress(sent, total);
              $("#msg").css("color","#666").text(`Uploading... (${sent}/${total})`);
              next();
            })
            .fail(function (xhr) {
              $("#msg").css("color","red").text("Error during bulkload. Open console.");
              console.log("Bulkload failed:", xhr);
              $("#seedBtn").prop("disabled", false);
            });
        }

        next();
      })
      .fail(function (xhr) {
        $("#msg").css("color","red").text("Cannot load meals_250_MealsDB.json (check path).");
        console.log("JSON load failed:", xhr);
        $("#seedBtn").prop("disabled", false);
      });
  });
</script>

</body>
</html>
